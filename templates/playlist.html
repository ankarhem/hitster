{% extends "base.html" %}

{% block title %}Hitster Cards - {{ title }}{% endblock %}

{% block body %}
<div class="min-h-screen flex flex-col">
    <!-- Header -->
    <div class="text-center py-8">
        <div class="mb-6">
            <i class="fas fa-music text-5xl text-green-500"></i>
        </div>
        <h1 class="text-4xl font-bold text-gray-300 mb-2">
            {{ title }}
        </h1>
        <p class="text-lg text-gray-500 mb-8">
            {{ total_tracks }} tracks ready to generate
        </p>

        <div class="flex justify-center items-center gap-2">
        <button
            id="generate-btn"
            hx-post="/api/playlist/{{ playlist_id }}/generate-pdfs"
            hx-target="body"
            hx-swap="innerHTML"
            hx-disable-element="self"
            class="bg-green-500 hover:bg-green-600 disabled:bg-neutral-800 disabled:text-neutral-600 text-white font-semibold py-3 px-8 rounded-lg spotify-green-hover transition duration-200 flex items-center gap-2"
            {% if self.has_job_in_progress() %}
            disabled
            {% endif %}
        >
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                      d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                      clip-rule="evenodd"/>
            </svg>
            <span>Generate PDFs</span>
        </button>
            <button
                    id="refetch-btn"
                    hx-post="/api/playlist/{{ playlist_id }}/refetch-playlist"
                    hx-target="body"
                    hx-swap="innerHTML"
                    hx-disable-element="self"
                    class="bg-green-500 hover:bg-green-600 disabled:bg-neutral-800 disabled:text-neutral-600 text-white font-semibold py-3 px-8 rounded-lg spotify-green-hover transition duration-200 flex items-center gap-2"
                    {% if self.has_job_in_progress() %}
                    disabled
                    {% endif %}
            >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                </svg>
                <span>Update Playlist</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 px-4 pb-12">
        <div class="max-w-6xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Preview Section -->
                <div class="lg:col-span-2">
                    <div class="bg-neutral-950 rounded-lg border border-neutral-800">
                        <div class="px-6 py-4 border-b border-neutral-800">
                            <h2 class="text-lg font-semibold text-gray-300">Song Preview</h2>
                            <p class="text-sm text-gray-500 mt-1">First 20 songs from your playlist</p>
                        </div>
                        <div class="">
                            <div class="divide-y divide-neutral-800 max-h-[400px] overflow-y-auto">
                                {% for track in tracks %}
                                {% if loop.index <= 20 %}
                                <div class="px-6 py-4 flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="flex-shrink-0 w-12 h-12 bg-black border border-neutral-800 rounded-lg overflow-hidden">
                                            {% if track.has_album_cover() %}
                                            <img src="{{ track.album_cover_url_or_empty() }}" alt="{{ track.title }} album cover" class="w-full h-full object-cover">
                                            {% else %}
                                            <div class="w-full h-full bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center">
                                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                                                </svg>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h3 class="text-sm font-medium text-gray-300">{{ track.title }}</h3>
                                            <p class="text-sm text-gray-500">{{ track.artist }} • {{ track.year }}</p>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 h-12 w-12">
                                        {{ track.qr_code | safe }}
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% if total_tracks > 20 %}
                                <div class="px-6 py-4 text-center">
                                    <p class="text-sm text-gray-500">... and {{ total_tracks - 20 }} more songs</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions Section -->
                <div class="lg:col-span-1">
                    <div class="bg-neutral-950 rounded-lg border border-neutral-800">
                        <div class="px-6 py-4 border-b border-neutral-800">
                            <h2 class="text-lg font-semibold text-gray-300">Download PDFs</h2>
                            <p class="text-sm text-gray-500 mt-1">Generate and download card files</p>
                        </div>

                        <div class="p-6 space-y-4">
                            <!-- Status Display -->
                            {% if self.has_job_in_progress() %}
                            {% if let Some(job) = latest_job %}
                                <div
                                    id="status-section"
                                    hx-ext="sse"
                                    sse-connect="/api/playlist/{{ playlist_id }}/jobs/{{ job.id }}/status"
                                >
                                    <div class="bg-blue-900/20 border border-blue-800 rounded-lg p-4">
                                        <div class="flex items-center space-x-3">
                                            <div>
                                                <div
                                                    hx-get="/playlist/{{ playlist_id }}" hx-trigger="sse:done"
                                                    hx-swap="innerHTML"
                                                    hx-target="body"
                                                ></div>
                                                <p hx-target="this" hx-swap="innerHTML" sse-swap="status" class="text-sm font-medium text-blue-300 capitalize">Queueing job...</p>
                                                <p class="text-xs text-blue-400">This may take a few moments</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            {% endif %}

                            <!-- Download Buttons -->
                            <div class="space-y-3">
                                <form
                                        target="_blank"
                                        method="get"
                                        action="/api/playlist/{{playlist_id}}/download-pdf/front"
                                >
                                    <button
                                            id="download-front-btn"
                                            type="submit"
                                            {% if !self.enable_download_buttons() %}

                                                disabled
                                            {% endif %}
                                            class="w-full bg-green-500 hover:bg-green-600 disabled:bg-neutral-800 disabled:text-neutral-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2 disabled:cursor-not-allowed"
                                    >
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                  d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                                  clip-rule="evenodd"/>
                                        </svg>
                                        <span>Download Front Sides</span>
                                    </button>
                                </form>

                                <form
                                        target="_blank"
                                        method="get"
                                        action="/api/playlist/{{playlist_id}}/download-pdf/back"
                                >
                                    <button
                                            id="download-back-btn"
                                            type="submit"
                                            {% if !self.enable_download_buttons() %}
                                            disabled
                                            {% endif %}
                                            class="w-full bg-green-500 hover:bg-green-600 disabled:bg-neutral-800 disabled:text-neutral-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2 disabled:cursor-not-allowed"
                                    >
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                  d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                                  clip-rule="evenodd"/>
                                        </svg>
                                        <span>Download Back Sides</span>
                                    </button>
                                </form>
                            </div>

                            <!-- Info -->
                            <div class="bg-black border border-neutral-800 rounded-lg p-4">
                                <h3 class="text-sm font-medium text-gray-300 mb-2">What's included:</h3>
                                <ul class="text-xs text-gray-500 space-y-1">
                                    <li>• Front sides: Song title, artist and release year</li>
                                    <li>• Back sides: QR Code to play the song</li>
                                    <li>• Optimized for printing on A4 paper</li>
                                    <li>• 12 cards per page (3x4 grid)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}